name: ğŸš€ Heneria Nexus CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to server after successful build'
        required: false
        default: false
        type: boolean

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120

jobs:
  # Job 1: Analyse statique et validation
  validate-project:
    name: ğŸ“Š Validation & Analyse
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    
    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ğŸ” DÃ©tection des changements
      id: changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(java|xml|yml|yaml|properties)$'; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changements dÃ©tectÃ©s dans le code source"
        else
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Aucun changement dans le code source"
        fi

    - name: ğŸ·ï¸ Extraction de la version
      id: get-version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Version du projet: $VERSION"

    - name: ğŸ” Validation de la structure du projet
      run: |
        echo "ğŸ—ï¸ Validation de la structure..."
        
        # VÃ©rifier les fichiers essentiels
        files_to_check=(
          "pom.xml"
          "src/main/java/fr/heneria/nexus/Nexus.java"
          "src/main/resources/plugin.yml"
          "src/main/resources/db/migration"
        )
        
        for file in "${files_to_check[@]}"; do
          if [[ -e "$file" ]]; then
            echo "âœ… $file"
          else
            echo "âŒ $file manquant"
            echo "::error::Fichier manquant: $file"
            exit 1
          fi
        done
    - name: ğŸ”§ Validation Maven
      run: |
        echo "ğŸ” Validation du projet Maven..."
        mvn validate -B -q
        
        echo ""
        echo "ğŸ“Š Informations du projet:"
        mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout | sed 's/^/  Group ID: /'
        mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout | sed 's/^/  Artifact ID: /'
        mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/^/  Version: /'

    - name: ğŸ§¹ Analyse des dÃ©pendances
      run: |
        echo "ğŸ” Analyse des dÃ©pendances..."
        
        # CrÃ©er le rapport de dÃ©pendances
        mvn dependency:analyze -B -q > dependency-analysis.txt 2>&1 || true
        
        echo "ğŸ“Š DÃ©pendances principales:"
        mvn dependency:list -B | grep -E "(mariadb|hikari|triumph|flyway|paper)" | sed 's/^/  /'
        
        echo ""
        echo "âš ï¸ Alertes potentielles:"
        if grep -E "(WARNING|ERROR)" dependency-analysis.txt; then
          echo "Des alertes ont Ã©tÃ© dÃ©tectÃ©es dans l'analyse des dÃ©pendances"
        else
          echo "âœ… Aucune alerte dÃ©tectÃ©e"
        fi

  # Job 2: Build et packaging
  build:
    name: ğŸ”¨ Build & Package
    runs-on: ubuntu-latest
    needs: validate-project
    if: needs.validate-project.outputs.has-changes == 'true'

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: testpassword123
          MYSQL_DATABASE: nexus_test
          MYSQL_USER: nexus_test
          MYSQL_PASSWORD: nexus_test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    outputs:
      jar-name: ${{ steps.build-info.outputs.jar-name }}
      jar-size: ${{ steps.build-info.outputs.jar-size }}

    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ğŸ—ƒï¸ VÃ©rification de la base de donnÃ©es
      run: |
        echo "ğŸ” Test de la base de donnÃ©es de test..."
        
        # Attendre que MariaDB soit prÃªt
        for i in {1..30}; do
          if mysql -h127.0.0.1 -P3306 -uroot -ptestpassword123 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… MariaDB est prÃªt"
            break
          fi
          echo "â³ Attente de MariaDB... ($i/30)"
          sleep 2
        done
        
        # VÃ©rifier la base de test
        mysql -h127.0.0.1 -P3306 -uroot -ptestpassword123 -e "SHOW DATABASES;" | grep nexus_test
        echo "âœ… Base de donnÃ©es nexus_test disponible"

    - name: ğŸ”§ Compilation
      run: |
        echo "ğŸ”¨ Compilation du projet..."
        mvn clean compile -B -q
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Compilation rÃ©ussie"
          echo "ğŸ“ Classes compilÃ©es:"
          find target/classes -name "*.class" | head -10 | sed 's/^/  /'
        else
          echo "âŒ Ã‰chec de la compilation"
          exit 1
        fi

    - name: ğŸ“¦ Packaging
      id: package
      run: |
        echo "ğŸ“¦ CrÃ©ation du package..."
        mvn package -B -DskipTests -q
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Packaging rÃ©ussi"
        else
          echo "âŒ Ã‰chec du packaging"
          exit 1
        fi

    - name: ğŸ” Analyse du JAR
      id: build-info
      run: |
        echo "ğŸ” Analyse du JAR crÃ©Ã©..."
        
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        JAR_NAME=$(basename "$JAR_FILE")
        JAR_SIZE=$(ls -lh "$JAR_FILE" | awk '{print $5}')
        
        echo "jar-name=$JAR_NAME" >> $GITHUB_OUTPUT
        echo "jar-size=$JAR_SIZE" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Informations du JAR:"
        echo "  ğŸ“ Nom: $JAR_NAME"
        echo "  ğŸ“ Taille: $JAR_SIZE"
        
        echo ""
        echo "ğŸ§ª VÃ©rification du contenu:"
        
        # VÃ©rifier les fichiers critiques
        critical_files=(
          "plugin.yml"
          "fr/heneria/nexus/Nexus.class"
          "org/mariadb/jdbc/Driver.class"
        )
        
        for file in "${critical_files[@]}"; do
          if jar tf "$JAR_FILE" | grep -q "$file"; then
            echo "  âœ… $file"
          else
            echo "  âŒ $file manquant"
            echo "::error::Fichier critique manquant dans le JAR: $file"
            exit 1
          fi
        done
        
        echo ""
        echo "ğŸ”§ Classes relocalisÃ©es:"
        jar tf "$JAR_FILE" | grep -E "fr/heneria/nexus/libs/" | head -5 | sed 's/^/  /' || echo "  â„¹ï¸ Aucune relocalisation dÃ©tectÃ©e"

    - name: ğŸ“¤ Upload du JAR
      uses: actions/upload-artifact@v4
      with:
        name: nexus-plugin-${{ needs.validate-project.outputs.version }}
        path: target/*.jar
        retention-days: 30

  # Job 3: Tests d'intÃ©gration complets
  integration-tests:
    name: ğŸ§ª Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: [validate-project, build]
    if: needs.validate-project.outputs.has-changes == 'true'

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: test_root_password
          MYSQL_DATABASE: nexus_integration_test
          MYSQL_USER: nexus_user
          MYSQL_PASSWORD: nexus_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ğŸ“¥ TÃ©lÃ©chargement du JAR
      uses: actions/download-artifact@v4
      with:
        name: nexus-plugin-${{ needs.validate-project.outputs.version }}
        path: target/

    - name: ğŸ¯ Tests de chargement des classes
      run: |
        echo "ğŸ§ª Test de chargement des classes critiques..."
        
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        
        # CrÃ©er un test Java complet
        cat > DatabaseConnectionTest.java << 'EOF'
        import java.sql.Connection;
        import java.sql.DriverManager;
        import java.sql.Statement;
        import java.sql.ResultSet;
        
        public class DatabaseConnectionTest {
            public static void main(String[] args) {
                System.out.println("ğŸ” Test de chargement du driver MariaDB...");
                
                try {
                    // Test 1: Chargement du driver
                    Class.forName("org.mariadb.jdbc.Driver");
                    System.out.println("âœ… Driver MariaDB chargÃ© avec succÃ¨s");
                    
                    // Test 2: Connexion Ã  la base
                    System.out.println("ğŸ”— Test de connexion Ã  la base...");
                    String url = "jdbc:mariadb://localhost:3306/nexus_integration_test";
                    String username = "nexus_user";
                    String password = "nexus_password";
                    
                    Connection conn = DriverManager.getConnection(url, username, password);
                    System.out.println("âœ… Connexion Ã©tablie avec succÃ¨s");
                    
                    // Test 3: OpÃ©ration basique
                    Statement stmt = conn.createStatement();
                    ResultSet rs = stmt.executeQuery("SELECT VERSION() as version");
                    if (rs.next()) {
                        System.out.println("ğŸ“‹ Version MariaDB: " + rs.getString("version"));
                    }
                    
                    // Test 4: CrÃ©ation de table (simulation Flyway)
                    stmt.executeUpdate("CREATE TABLE IF NOT EXISTS test_table (id INT PRIMARY KEY, name VARCHAR(255))");
                    stmt.executeUpdate("INSERT INTO test_table (id, name) VALUES (1, 'Test Plugin') ON DUPLICATE KEY UPDATE name = VALUES(name)");
                    
                    ResultSet testRs = stmt.executeQuery("SELECT name FROM test_table WHERE id = 1");
                    if (testRs.next()) {
                        System.out.println("âœ… Test CRUD rÃ©ussi: " + testRs.getString("name"));
                    }
                    
                    // Nettoyage
                    stmt.executeUpdate("DROP TABLE test_table");
                    conn.close();
                    
                    System.out.println("ğŸ‰ Tous les tests d'intÃ©gration rÃ©ussis !");
                    
                } catch (Exception e) {
                    System.err.println("âŒ Erreur dans les tests: " + e.getMessage());
                    e.printStackTrace();
                    System.exit(1);
                }
            }
        }
        EOF
        
        # Attendre que MariaDB soit prÃªt
        echo "â³ Attente de MariaDB..."
        for i in {1..30}; do
          if mysql -h127.0.0.1 -P3306 -unexus_user -pnexus_password -e "SELECT 1;" &>/dev/null; then
            echo "âœ… MariaDB est prÃªt pour les tests"
            break
          fi
          sleep 2
        done
        
        # Compiler et exÃ©cuter le test
        javac -cp "$JAR_FILE" DatabaseConnectionTest.java
        java -cp "$JAR_FILE:." DatabaseConnectionTest

    - name: ğŸ§ª Test de simulation Flyway
      run: |
        echo "ğŸ§ª Test de simulation des migrations Flyway..."
        
        # VÃ©rifier que Flyway est bien inclus
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        if jar tf "$JAR_FILE" | grep -q "org/flywaydb"; then
          echo "âœ… Flyway dÃ©tectÃ© dans le JAR"
        else
          echo "âŒ Flyway non trouvÃ© dans le JAR"
          exit 1
        fi

  # Job 4: Analyse de sÃ©curitÃ©
  security-scan:
    name: ğŸ›¡ï¸ Analyse de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [validate-project, build]
    if: needs.validate-project.outputs.has-changes == 'true'
    continue-on-error: true  # Ne pas faire Ã©chouer le build pour les vulnÃ©rabilitÃ©s

    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ğŸ›¡ï¸ Scan de sÃ©curitÃ© des dÃ©pendances
      run: |
        echo "ğŸ” Analyse de sÃ©curitÃ© des dÃ©pendances..."
        
        # Installer et exÃ©cuter OWASP Dependency Check
        mvn org.owasp:dependency-check-maven:check \
          -DfailBuildOnCVSS=8 \
          -DsuppressFailureOnError=true \
          -Dformats=ALL \
          -B -q || echo "âš ï¸ Des vulnÃ©rabilitÃ©s ont Ã©tÃ© dÃ©tectÃ©es"
        
        # Afficher un rÃ©sumÃ© si le rapport existe
        if [[ -f target/dependency-check-report.html ]]; then
          echo "ğŸ“Š Rapport de sÃ©curitÃ© gÃ©nÃ©rÃ©"
          if [[ -f target/dependency-check-report.json ]]; then
            echo "ğŸ” Analyse du rapport JSON..."
            # Ici on pourrait parser le JSON pour extraire un rÃ©sumÃ©
          fi
        fi

    - name: ğŸ“¤ Upload rapport de sÃ©curitÃ©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-${{ needs.validate-project.outputs.version }}
        path: target/dependency-check-report.*
        retention-days: 30

  # Job 5: MÃ©triques et qualitÃ©
  code-quality:
    name: ğŸ“Š QualitÃ© du Code
    runs-on: ubuntu-latest
    needs: [validate-project]
    if: needs.validate-project.outputs.has-changes == 'true'

    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ“Š MÃ©triques de code
      run: |
        echo "ğŸ“ˆ Analyse des mÃ©triques du code..."
        
        # Comptage des lignes
        total_lines=$(find src -name "*.java" -exec cat {} \; | wc -l)
        java_files=$(find src -name "*.java" | wc -l)
        
        echo "ğŸ“ Total lignes de code Java: $total_lines"
        echo "ğŸ“ Nombre de fichiers Java: $java_files"
        
        if [[ $java_files -gt 0 ]]; then
          avg_lines=$((total_lines / java_files))
          echo "ğŸ“Š Moyenne lignes par fichier: $avg_lines"
        fi
        
        echo ""
        echo "ğŸ—ï¸ RÃ©partition par package:"
        find src -name "*.java" -exec dirname {} \; | sort | uniq -c | sort -nr | head -10
        
        echo ""
        echo "âš ï¸ Marqueurs de dÃ©veloppement:"
        grep -r -n "TODO\|FIXME\|XXX" src/ || echo "âœ… Aucun marqueur TODO/FIXME trouvÃ©"

  # Job 6: Rapport final et dÃ©ploiement conditionnel
  finalize:
    name: ğŸ“‹ Finalisation
    runs-on: ubuntu-latest
    needs: [validate-project, build, integration-tests, security-scan, code-quality]
    if: always()

    steps:
    - name: ğŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ“Š GÃ©nÃ©ration du rapport final
      run: |
        echo "# ğŸ¯ Rapport CI/CD Nexus Plugin" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“‹ Informations du Build" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.validate-project.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branche**: ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "- **JAR**: ${{ needs.build.outputs.jar-name || 'Non gÃ©nÃ©rÃ©' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Taille**: ${{ needs.build.outputs.jar-size || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ¯ RÃ©sultats des Jobs" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Statut |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“Š Validation | ${{ needs.validate-project.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”¨ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ›¡ï¸ SÃ©curitÃ© | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“Š QualitÃ© | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # DÃ©terminer le statut global
        if [[ "${{ needs.validate-project.result }}" == "success" && \
              "${{ needs.build.result }}" == "success" && \
              "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "## ğŸ‰ Build RÃ©ussi !" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Le plugin a passÃ© tous les tests critiques et est prÃªt pour le dÃ©ploiement." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ TÃ©lÃ©chargement" >> $GITHUB_STEP_SUMMARY
          echo "Le JAR compilÃ© est disponible dans les artifacts de ce build." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Build Ã‰chouÃ©" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ” VÃ©rifiez les logs des jobs Ã©chouÃ©s pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*GÃ©nÃ©rÃ© automatiquement par Heneria CI/CD*" >> $GITHUB_STEP_SUMMARY

    - name: ğŸš€ Notification de dÃ©ploiement (si succÃ¨s)
      if: >
        needs.validate-project.result == 'success' &&
        needs.build.result == 'success' &&
        needs.integration-tests.result == 'success' &&
        github.event.inputs.deploy == 'true'
      run: |
        echo "ğŸš€ Le plugin est prÃªt pour le dÃ©ploiement !"
        echo "ğŸ“¦ Artifact: ${{ needs.build.outputs.jar-name }}"
        echo "ğŸ’¾ Taille: ${{ needs.build.outputs.jar-size }}"
        echo ""
        echo "Pour dÃ©ployer manuellement:"
        echo "1. TÃ©lÃ©charger l'artifact depuis cette action"
        echo "2. L'uploader sur le serveur avec WinSCP ou le script deploy.sh"
        echo "3. RedÃ©marrer le serveur Minecraft"

