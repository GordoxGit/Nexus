name: ðŸš€ Heneria Nexus CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to server after successful build'
        required: false
        default: false
        type: boolean

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120

jobs:
  # Job 1: Analyse statique et validation
  validate-project:
    name: ðŸ“Š Validation & Analyse
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    
    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ðŸ” DÃ©tection des changements
      id: changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(java|xml|yml|yaml|properties)$'; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changements dÃ©tectÃ©s dans le code source"
        else
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Aucun changement dans le code source"
        fi

    - name: ðŸ·ï¸ Extraction de la version
      id: get-version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Version du projet: $VERSION"

    - name: ðŸ” Validation de la structure du projet
      run: |
        echo "ðŸ—ï¸ Validation de la structure..."
        
        # VÃ©rifier les fichiers essentiels
        files_to_check=(
          "pom.xml"
          "src/main/java/fr/heneria/nexus/Nexus.java"
          "src/main/resources/plugin.yml"
          "src/main/resources/db/migration"
        )
        
        for file in "${files_to_check[@]}"; do
          if [[ -e "$file" ]]; then
            echo "âœ… $file"
          else
            echo "âŒ $file manquant"
            echo "::error::Fichier manquant: $file"
            exit 1
          fi
        done
    - name: ðŸ”§ Validation Maven
      run: |
        echo "ðŸ” Validation du projet Maven..."
        mvn validate -B -q
        
        echo ""
        echo "ðŸ“Š Informations du projet:"
        mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout | sed 's/^/  Group ID: /'
        mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout | sed 's/^/  Artifact ID: /'
        mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/^/  Version: /'

    - name: ðŸ§¹ Analyse des dÃ©pendances
      run: |
        echo "ðŸ” Analyse des dÃ©pendances..."
        
        # CrÃ©er le rapport de dÃ©pendances
        mvn dependency:analyze -B -q > dependency-analysis.txt 2>&1 || true
        
        echo "ðŸ“Š DÃ©pendances principales:"
        mvn dependency:list -B | grep -E "(mariadb|hikari|triumph|flyway|paper)" | sed 's/^/  /'
        
        echo ""
        echo "âš ï¸ Alertes potentielles:"
        if grep -E "(WARNING|ERROR)" dependency-analysis.txt; then
          echo "Des alertes ont Ã©tÃ© dÃ©tectÃ©es dans l'analyse des dÃ©pendances"
        else
          echo "âœ… Aucune alerte dÃ©tectÃ©e"
        fi

  # Job 2: Build et packaging
  build:
    name: ðŸ”¨ Build & Package
    runs-on: ubuntu-latest
    needs: validate-project
    if: needs.validate-project.outputs.has-changes == 'true'

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: testpassword123
          MYSQL_DATABASE: nexus_test
          MYSQL_USER: nexus_test
          MYSQL_PASSWORD: nexus_test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    outputs:
      jar-name: ${{ steps.build-info.outputs.jar-name }}
      jar-size: ${{ steps.build-info.outputs.jar-size }}

    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ðŸ—ƒï¸ VÃ©rification de la base de donnÃ©es
      run: |
        echo "ðŸ” Test de la base de donnÃ©es de test..."
        
        # Attendre que MariaDB soit prÃªt
        for i in {1..30}; do
          if mysql -h127.0.0.1 -P3306 -uroot -ptestpassword123 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… MariaDB est prÃªt"
            break
          fi
          echo "â³ Attente de MariaDB... ($i/30)"
          sleep 2
        done
        
        # VÃ©rifier la base de test
        mysql -h127.0.0.1 -P3306 -uroot -ptestpassword123 -e "SHOW DATABASES;" | grep nexus_test
        echo "âœ… Base de donnÃ©es nexus_test disponible"

    - name: ðŸ”§ Compilation
      run: |
        echo "ðŸ”¨ Compilation du projet..."
        mvn clean compile -B -q
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Compilation rÃ©ussie"
          echo "ðŸ“ Classes compilÃ©es:"
          find target/classes -name "*.class" | head -10 | sed 's/^/  /'
        else
          echo "âŒ Ã‰chec de la compilation"
          exit 1
        fi

    - name: ðŸ“¦ Packaging
      id: package
      run: |
        echo "ðŸ“¦ CrÃ©ation du package..."
        mvn package -B -DskipTests -q
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… Packaging rÃ©ussi"
        else
          echo "âŒ Ã‰chec du packaging"
          exit 1
        fi

    - name: ðŸ” Analyse du JAR
      id: build-info
      run: |
        echo "ðŸ” Analyse du JAR crÃ©Ã©..."

        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "original-*" | head -1)
        JAR_NAME=$(basename "$JAR_FILE")
        JAR_SIZE=$(ls -lh "$JAR_FILE" | awk '{print $5}')

        echo "jar-name=$JAR_NAME" >> $GITHUB_OUTPUT
        echo "jar-size=$JAR_SIZE" >> $GITHUB_OUTPUT

        echo "ðŸ“Š Informations du JAR:"
        echo "  ðŸ“ Nom: $JAR_NAME"
        echo "  ðŸ“ Taille: $JAR_SIZE"

        # VÃ©rifier la taille minimale attendue (doit Ãªtre > 5MB)
        JAR_SIZE_BYTES=$(stat -c%s "$JAR_FILE")
        MIN_SIZE_BYTES=5242880  # 5MB
        if [[ $JAR_SIZE_BYTES -lt $MIN_SIZE_BYTES ]]; then
            echo "âš ï¸ ATTENTION: JAR trop petit ($JAR_SIZE), les dÃ©pendances sont probablement manquantes"
            echo "::warning::JAR size is too small, dependencies might be missing"
        fi

        echo ""
        echo "ðŸ§ª VÃ©rification du contenu:"

        # VÃ©rifier les fichiers critiques avec une approche plus robuste
        critical_files=(
          "plugin.yml"
          "fr/heneria/nexus/Nexus.class"
          "org/mariadb/jdbc/Driver.class"
          "fr/heneria/nexus/libs/hikari/HikariDataSource.class"
          "fr/heneria/nexus/libs/flywaydb/core/Flyway.class"
        )

        for file in "${critical_files[@]}"; do
          if jar tf "$JAR_FILE" | grep -q "$file"; then
            echo "  âœ… $file"
          else
            echo "  âŒ $file manquant"
            echo "::error::Fichier critique manquant dans le JAR: $file"
            exit 1
          fi
        done

        # VÃ©rification spÃ©ciale pour Triumph GUI (recherche dynamique)
        echo ""
        echo "ðŸ” VÃ©rification de Triumph GUI:"
        GUI_CLASSES=$(jar tf "$JAR_FILE" | grep "fr/heneria/nexus/libs/gui/" | head -3)
        if [ -z "$GUI_CLASSES" ]; then
          echo "  âŒ Aucune classe Triumph GUI trouvÃ©e dans fr/heneria/nexus/libs/gui/"
          echo "::error::Triumph GUI non relocalisÃ© correctement"
          exit 1
        else
          echo "  âœ… Classes Triumph GUI dÃ©tectÃ©es:"
          echo "$GUI_CLASSES" | sed 's/^/    /'

          if jar tf "$JAR_FILE" | grep -q "fr/heneria/nexus/libs/gui.*Gui\\.class"; then
            echo "  âœ… Classe Gui principale trouvÃ©e"
          else
            echo "  âš ï¸  Aucune classe Gui principale dÃ©tectÃ©e, mais d'autres classes GUI sont prÃ©sentes"
          fi
        fi

        echo ""
        echo "ðŸ“ˆ Analyse dÃ©taillÃ©e des dÃ©pendances relocalisÃ©es:"

        count_and_display() {
          local pattern="$1"
          local name="$2"
          local count=$(jar tf "$JAR_FILE" | grep -c "$pattern" || echo "0")
          echo "  $name: $count classes"
          if [ "$count" -gt 0 ]; then
            echo "    $(jar tf "$JAR_FILE" | grep "$pattern" | head -2 | sed 's/^/    â”œâ”€ /')"
            if [ "$count" -gt 2 ]; then
              echo "    â””â”€ ... et $((count-2)) autres"
            fi
          fi
        }

        count_and_display "org/mariadb/" "MariaDB JDBC"
        count_and_display "fr/heneria/nexus/libs/hikari/" "HikariCP (relocalisÃ©)"
        count_and_display "fr/heneria/nexus/libs/flywaydb/" "Flyway (relocalisÃ©)"
        count_and_display "fr/heneria/nexus/libs/gui/" "Triumph GUI (relocalisÃ©)"

        echo ""
        echo "ðŸ”’ VÃ©rification des fuites de relocalisation:"
        LEAKED_CLASSES=""
        for pattern in "com/zaxxer/hikari" "org/flywaydb" "dev/triumphteam/gui"; do
          if jar tf "$JAR_FILE" | grep -q "$pattern"; then
            LEAKED_CLASSES="$LEAKED_CLASSES $pattern"
          fi
        done

        if [ -n "$LEAKED_CLASSES" ]; then
          echo "  âš ï¸  Classes non-relocalisÃ©es dÃ©tectÃ©es: $LEAKED_CLASSES"
          echo "  Cela peut causer des conflits de versions avec d'autres plugins"
        else
          echo "  âœ… Toutes les dÃ©pendances sont correctement relocalisÃ©es"
        fi

    - name: ðŸ“¤ Upload du JAR
      uses: actions/upload-artifact@v4
      with:
        name: nexus-plugin-${{ needs.validate-project.outputs.version }}
        path: target/*.jar
        retention-days: 30

  # Job 3: Tests d'intÃ©gration complets
  integration-tests:
    name: ðŸ§ª Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: [validate-project, build]
    if: needs.validate-project.outputs.has-changes == 'true'

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: test_root_password
          MYSQL_DATABASE: nexus_integration_test
          MYSQL_USER: nexus_user
          MYSQL_PASSWORD: nexus_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ðŸ“¥ TÃ©lÃ©chargement du JAR
      uses: actions/download-artifact@v4
      with:
        name: nexus-plugin-${{ needs.validate-project.outputs.version }}
        path: target/

    - name: ðŸš€ Test de chargement du plugin (Smoke Test)
      run: |
        echo "ðŸš€ Test de chargement du plugin (Smoke Test):"
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        cat > PluginLoadTest.java << 'EOF'
        import java.lang.reflect.Method;

        public class PluginLoadTest {
            public static void main(String[] args) {
                try {
                    Class<?> nexusClass = Class.forName("fr.heneria.nexus.Nexus");
                    System.out.println("âœ… Classe Nexus chargÃ©e: " + nexusClass.getName());

                    Class<?> hikariClass = Class.forName("fr.heneria.nexus.libs.hikari.HikariDataSource");
                    System.out.println("âœ… HikariCP relocalisÃ© chargÃ©: " + hikariClass.getName());

                    Class<?> flywayClass = Class.forName("fr.heneria.nexus.libs.flywaydb.core.Flyway");
                    System.out.println("âœ… Flyway relocalisÃ© chargÃ©: " + flywayClass.getName());

                    String[] possibleClasses = {
                        "fr.heneria.nexus.libs.gui.guis.Gui",
                        "fr.heneria.nexus.libs.gui.guis.BaseGui",
                        "fr.heneria.nexus.libs.gui.components.GuiType"
                    };

                    boolean guiFound = false;
                    for (String className : possibleClasses) {
                        try {
                            Class<?> guiClass = Class.forName(className);
                            System.out.println("âœ… Triumph GUI relocalisÃ© chargÃ©: " + guiClass.getName());
                            guiFound = true;
                            break;
                        } catch (ClassNotFoundException ignored) {}
                    }

                    if (!guiFound) {
                        System.err.println("âŒ Aucune classe Triumph GUI trouvÃ©e");
                        System.exit(1);
                    }

                    System.out.println("ðŸŽ‰ Tous les tests de chargement de classes rÃ©ussis !");

                } catch (Exception e) {
                    System.err.println("âŒ Erreur lors du test de chargement: " + e.getMessage());
                    e.printStackTrace();
                    System.exit(1);
                }
            }
        }
        EOF
        javac -cp "$JAR_FILE" PluginLoadTest.java
        java -cp "$JAR_FILE:." PluginLoadTest

    - name: ðŸŽ¯ Tests de chargement des classes
      run: |
        echo "ðŸ§ª Test de chargement des classes critiques..."
        
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        
        # CrÃ©er un test Java complet
        cat > DatabaseConnectionTest.java << 'EOF'
        import java.sql.Connection;
        import java.sql.DriverManager;
        import java.sql.Statement;
        import java.sql.ResultSet;
        import com.zaxxer.hikari.HikariConfig;

        public class DatabaseConnectionTest {
            public static void main(String[] args) {
                System.out.println("ðŸ” Test de chargement du driver MariaDB...");

                try {
                    // Test 1: Chargement du driver
                    Class.forName("org.mariadb.jdbc.Driver");
                    System.out.println("âœ… Driver MariaDB chargÃ© avec succÃ¨s");

                    String url = "jdbc:mariadb://localhost:3306/nexus_integration_test";
                    String username = "nexus_user";
                    String password = "nexus_password";

                    // Test 2: VÃ©rification des classes HikariCP
                    HikariConfig config = new HikariConfig();
                    config.setJdbcUrl(url);
                    config.setUsername(username);
                    config.setPassword(password);
                    System.out.println("âœ… HikariCP disponible dans le JAR");

                    // Test 3: Connexion Ã  la base
                    System.out.println("ðŸ”— Test de connexion Ã  la base...");
                    Connection conn = DriverManager.getConnection(url, username, password);
                    System.out.println("âœ… Connexion Ã©tablie avec succÃ¨s");

                    // Test 4: OpÃ©ration basique
                    Statement stmt = conn.createStatement();
                    ResultSet rs = stmt.executeQuery("SELECT VERSION() as version");
                    if (rs.next()) {
                        System.out.println("ðŸ“‹ Version MariaDB: " + rs.getString("version"));
                    }

                    // Test 5: CrÃ©ation de table (simulation Flyway)
                    stmt.executeUpdate("CREATE TABLE IF NOT EXISTS test_table (id INT PRIMARY KEY, name VARCHAR(255))");
                    stmt.executeUpdate("INSERT INTO test_table (id, name) VALUES (1, 'Test Plugin') ON DUPLICATE KEY UPDATE name = VALUES(name)");

                    ResultSet testRs = stmt.executeQuery("SELECT name FROM test_table WHERE id = 1");
                    if (testRs.next()) {
                        System.out.println("âœ… Test CRUD rÃ©ussi: " + testRs.getString("name"));
                    }

                    // Nettoyage
                    stmt.executeUpdate("DROP TABLE test_table");
                    conn.close();

                    System.out.println("ðŸŽ‰ Tous les tests d'intÃ©gration rÃ©ussis !");

                } catch (Exception e) {
                    System.err.println("âŒ Erreur dans les tests: " + e.getMessage());
                    e.printStackTrace();
                    System.exit(1);
                }
            }
        }
        EOF
        
        # Attendre que MariaDB soit prÃªt
        echo "â³ Attente de MariaDB..."
        for i in {1..30}; do
          if mysql -h127.0.0.1 -P3306 -unexus_user -pnexus_password -e "SELECT 1;" &>/dev/null; then
            echo "âœ… MariaDB est prÃªt pour les tests"
            break
          fi
          sleep 2
        done
        
        # Compiler et exÃ©cuter le test
        javac -cp "$JAR_FILE" DatabaseConnectionTest.java
        java -cp "$JAR_FILE:." DatabaseConnectionTest

    - name: ðŸ§ª Test de simulation Flyway
      run: |
        echo "ðŸ§ª Test de simulation des migrations Flyway..."
        
        # VÃ©rifier que Flyway est bien inclus
        JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
        if jar tf "$JAR_FILE" | grep -q "org/flywaydb"; then
          echo "âœ… Flyway dÃ©tectÃ© dans le JAR"
        else
          echo "âŒ Flyway non trouvÃ© dans le JAR"
          exit 1
        fi

  # Job 4: Analyse de sÃ©curitÃ©
  security-scan:
    name: ðŸ›¡ï¸ Analyse de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [validate-project, build]
    if: needs.validate-project.outputs.has-changes == 'true'
    continue-on-error: true  # Ne pas faire Ã©chouer le build pour les vulnÃ©rabilitÃ©s

    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: â˜• Configuration Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: ðŸ›¡ï¸ Scan de sÃ©curitÃ© des dÃ©pendances
      run: |
        echo "ðŸ” Analyse de sÃ©curitÃ© des dÃ©pendances..."
        
        # Installer et exÃ©cuter OWASP Dependency Check
        mvn org.owasp:dependency-check-maven:check \
          -DfailBuildOnCVSS=8 \
          -DsuppressFailureOnError=true \
          -Dformats=ALL \
          -B -q || echo "âš ï¸ Des vulnÃ©rabilitÃ©s ont Ã©tÃ© dÃ©tectÃ©es"
        
        # Afficher un rÃ©sumÃ© si le rapport existe
        if [[ -f target/dependency-check-report.html ]]; then
          echo "ðŸ“Š Rapport de sÃ©curitÃ© gÃ©nÃ©rÃ©"
          if [[ -f target/dependency-check-report.json ]]; then
            echo "ðŸ” Analyse du rapport JSON..."
            # Ici on pourrait parser le JSON pour extraire un rÃ©sumÃ©
          fi
        fi

    - name: ðŸ“¤ Upload rapport de sÃ©curitÃ©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-${{ needs.validate-project.outputs.version }}
        path: target/dependency-check-report.*
        retention-days: 30

  # Job 5: MÃ©triques et qualitÃ©
  code-quality:
    name: ðŸ“Š QualitÃ© du Code
    runs-on: ubuntu-latest
    needs: [validate-project]
    if: needs.validate-project.outputs.has-changes == 'true'

    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸ“Š MÃ©triques de code
      run: |
        echo "ðŸ“ˆ Analyse des mÃ©triques du code..."
        
        # Comptage des lignes
        total_lines=$(find src -name "*.java" -exec cat {} \; | wc -l)
        java_files=$(find src -name "*.java" | wc -l)
        
        echo "ðŸ“ Total lignes de code Java: $total_lines"
        echo "ðŸ“ Nombre de fichiers Java: $java_files"
        
        if [[ $java_files -gt 0 ]]; then
          avg_lines=$((total_lines / java_files))
          echo "ðŸ“Š Moyenne lignes par fichier: $avg_lines"
        fi
        
        echo ""
        echo "ðŸ—ï¸ RÃ©partition par package:"
        find src -name "*.java" -exec dirname {} \; | sort | uniq -c | sort -nr | head -10
        
        echo ""
        echo "âš ï¸ Marqueurs de dÃ©veloppement:"
        grep -r -n "TODO\|FIXME\|XXX" src/ || echo "âœ… Aucun marqueur TODO/FIXME trouvÃ©"

  # Job 6: Rapport final et dÃ©ploiement conditionnel
  finalize:
    name: ðŸ“‹ Finalisation
    runs-on: ubuntu-latest
    needs: [validate-project, build, integration-tests, security-scan, code-quality]
    if: always()

    steps:
    - name: ðŸ”„ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸ“Š GÃ©nÃ©ration du rapport final
      run: |
        echo "# ðŸŽ¯ Rapport CI/CD Nexus Plugin" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“‹ Informations du Build" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.validate-project.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branche**: ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "- **JAR**: ${{ needs.build.outputs.jar-name || 'Non gÃ©nÃ©rÃ©' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Taille**: ${{ needs.build.outputs.jar-size || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŽ¯ RÃ©sultats des Jobs" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Statut |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š Validation | ${{ needs.validate-project.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¨ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ›¡ï¸ SÃ©curitÃ© | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š QualitÃ© | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # DÃ©terminer le statut global
        if [[ "${{ needs.validate-project.result }}" == "success" && \
              "${{ needs.build.result }}" == "success" && \
              "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "## ðŸŽ‰ Build RÃ©ussi !" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Le plugin a passÃ© tous les tests critiques et est prÃªt pour le dÃ©ploiement." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ TÃ©lÃ©chargement" >> $GITHUB_STEP_SUMMARY
          echo "Le JAR compilÃ© est disponible dans les artifacts de ce build." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Build Ã‰chouÃ©" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” VÃ©rifiez les logs des jobs Ã©chouÃ©s pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*GÃ©nÃ©rÃ© automatiquement par Heneria CI/CD*" >> $GITHUB_STEP_SUMMARY

    - name: ðŸš€ Notification de dÃ©ploiement (si succÃ¨s)
      if: >
        needs.validate-project.result == 'success' &&
        needs.build.result == 'success' &&
        needs.integration-tests.result == 'success' &&
        github.event.inputs.deploy == 'true'
      run: |
        echo "ðŸš€ Le plugin est prÃªt pour le dÃ©ploiement !"
        echo "ðŸ“¦ Artifact: ${{ needs.build.outputs.jar-name }}"
        echo "ðŸ’¾ Taille: ${{ needs.build.outputs.jar-size }}"
        echo ""
        echo "Pour dÃ©ployer manuellement:"
        echo "1. TÃ©lÃ©charger l'artifact depuis cette action"
        echo "2. L'uploader sur le serveur avec WinSCP ou le script deploy.sh"
        echo "3. RedÃ©marrer le serveur Minecraft"

